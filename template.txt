AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  sam-idwall-transferra

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 14
    MemorySize: 128
    Runtime: nodejs14.x
    Environment:
      Variables:
        URL_IDWALL_ENDPOINT: "b824-2804-14d-5c43-8a44-3578-41-b0bd-f8ca.ngrok-free.app"
        IDWALL_TOKEN: "tokenidwall"
        URL_TRANSFEERA_ENDPOINT: "b824-2804-14d-5c43-8a44-3578-41-b0bd-f8ca.ngrok-free.app"
        TRANSFEERA_TOKEN: "tokentransfeera"
        URL_PIPEFY_ENDPOINT: "b824-2804-14d-5c43-8a44-3578-41-b0bd-f8ca.ngrok-free.app"
        PIPEFY_TOKEN: "tokenpipefy"
        SQSqueueName: !Ref queueReportData
        SQSqueueStartProcess: !Ref newSupplierCardMovedQueue

Resources:
  ########### ###########
  ########### Início do Fluxo do webhook
  ########### ###########
  newSupplierCardMovedFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      Timeout: 3
      CodeUri: src/newSupplierCardMovedFunction/
      Handler: newSupplierCardMovedFunction.newSupplierCardMovedFunction
      Architectures:
        - x86_64
      Events:
        newSupplier:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /pipefyWebhook/newSupplier/cardMoved/
            Method: post
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !Ref newSupplierCardMovedQueue
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt newSupplierCardMovedQueue.Arn
      Layers:
        - !Ref customLibs

  customLibs:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: SAM-Events-Advance-Helpers
      Description: Custom Libs shared between lambdas
      ContentUri: ./customLibs
      CompatibleRuntimes:
        - nodejs14.x

  newSupplierCardMovedQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      DelaySeconds: 0
      KmsDataKeyReusePeriodSeconds: 300 # 5 minutes (default)
      KmsMasterKeyId: alias/aws/sqs
      MaximumMessageSize: 262144 # 256 KiB (default)
      MessageRetentionPeriod: 1209600 # 14 days
      ReceiveMessageWaitTimeSeconds: 20 # long-polling
      VisibilityTimeout: 120 # 2 minutes

  triggerNewSupplierCardMovedFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: src/triggerNewSupplierCardMovedFunction/
      Handler: triggerNewSupplierCardMovedFunction.triggerNewSupplierCardMovedFunction
      Architectures:
        - x86_64
      Events:
        newSupplierCardMovedQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt newSupplierCardMovedQueue.Arn
            BatchSize: 10
            Enabled: True
      Layers:
        - !Ref customLibs

  ########### ###########
  ########### Fluxo de análise Transfeera e idWall
  ########### ###########
  functionEnviaParaAnalise:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: src/functionEnviaParaAnalise/
      Handler: functionEnviaParaAnalise.functionEnviaParaAnalise
      Architectures:
        - x86_64
      Events:
        jobEnviaParaAnalise:
          Type: Schedule # https://github.com/aws/serverless-application-model/blob/master/versions/2016-10-31.md#schedule
          Properties:
            Schedule: rate(10 minutes) # https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html#:~:text=You%20can%20use%20the%20following%20sample%20cron%20strings%20when%20creating%20a%20rule%20with%20schedule.
            Description: executar a análise da idwall e da transfeera
            Enabled: True
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !Ref queueReportData
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
                - "sqs:receiveMessage"
                - "sqs:deleteMessage"
              Resource: !GetAtt queueReportData.Arn
      Layers:
        - !Ref customLibs

  queueReportData:
    Type: "AWS::SQS::Queue"
    Properties:
      DelaySeconds: 0
      KmsDataKeyReusePeriodSeconds: 600 # 10 minutes
      KmsMasterKeyId: alias/aws/sqs
      MaximumMessageSize: 262144 # 256 KiB (default)
      MessageRetentionPeriod: 1209600 # 14 days
      ReceiveMessageWaitTimeSeconds: 20 # long-polling
      VisibilityTimeout: 120 # 2 minutes

Outputs:
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  newSupplierApi:
    Description: "API Gateway endpoint URL for Prod stage for newSupplierCardMovedFunction"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/pipefyWebhook/newSupplier/cardMoved/"
  newSupplierCardMovedFunction:
    Description: "newSupplierCardMovedFunction ARN"
    Value: !GetAtt newSupplierCardMovedFunction.Arn
  newSupplierCardMovedFunctionIamRole:
    Description: "Implicit IAM Role created for newSupplierCardMovedFunction function"
    Value: !GetAtt newSupplierCardMovedFunctionRole.Arn
  newSupplierCardMovedQueue:
    Description: SQS queue URL
    Value: !Ref newSupplierCardMovedQueue
  functionEnviaParaAnalise:
    Description: "Envia functionEnviaParaAnalise Analise Lambda Function ARN"
    Value: !GetAtt functionEnviaParaAnalise.Arn
  functionEnviaParaAnaliseIamRole:
    Description: "Implicit IAM Role created for functionEnviaParaAnalise"
    Value: !GetAtt functionEnviaParaAnalise.Arn
  queueReportData:
    Description: SQS queue URL
    Value: !Ref queueReportData
